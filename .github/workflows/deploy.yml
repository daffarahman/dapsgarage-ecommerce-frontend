name: Deploy Frontend

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Create .env file
        run: |
          echo "VITE_API_BASE_URL=${{ secrets.VITE_API_BASE_URL }}" > .env

      - name: Build Docker Image
        run: |
          docker build -t dapsgarage-frontend:latest .

      - name: Deploy Container
        run: |
          # Stop and remove the old container if it exists
          docker stop dapsgarage-frontend || true
          docker rm dapsgarage-frontend || true
          
          # Run the new container
          docker run -d \
            --name dapsgarage-frontend \
            -p 6701:80 \
            --restart unless-stopped \
            dapsgarage-frontend:latest

      - name: Cleanup Old Images
        run: |
          # Prevents VPS storage from filling up with "dangling" images
          docker image prune -f